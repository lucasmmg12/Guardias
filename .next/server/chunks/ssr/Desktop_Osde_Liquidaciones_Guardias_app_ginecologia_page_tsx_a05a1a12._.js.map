{"version":3,"sources":["../../../../../../../../Desktop/Osde/Liquidaciones/Guardias/app/ginecologia/page.tsx","../../../../../../../../Desktop/Osde/Liquidaciones/Guardias/components/custom/MesSelectorModal.tsx","../../../../../../../../Desktop/Osde/Liquidaciones/Guardias/lib/ginecologia-processor.ts"],"sourcesContent":["'use client'\r\n\r\nimport { useState, useEffect, useRef } from 'react'\r\nimport { useRouter } from 'next/navigation'\r\nimport { UploadExcel } from '@/components/custom/UploadExcel'\r\nimport { ExcelDataTable } from '@/components/custom/ExcelDataTable'\r\nimport { EstadisticasObraSocial } from '@/components/custom/EstadisticasObraSocial'\r\nimport { MesSelectorModal } from '@/components/custom/MesSelectorModal'\r\nimport { NotificationModal, NotificationType } from '@/components/custom/NotificationModal'\r\nimport { DetalleGuardiaTable } from '@/components/custom/DetalleGuardiaTable'\r\nimport { readExcelFile, ExcelData } from '@/lib/excel-reader'\r\nimport { procesarExcelGinecologia } from '@/lib/ginecologia-processor'\r\nimport { supabase } from '@/lib/supabase/client'\r\nimport { LiquidacionGuardia, EstadoLiquidacion } from '@/lib/types'\r\nimport { AlertCircle, CheckCircle2, Sparkles, ArrowLeft, Clock } from 'lucide-react'\r\nimport Link from 'next/link'\r\nimport { Button } from '@/components/ui/button'\r\n\r\nexport default function GinecologiaPage() {\r\n    const router = useRouter()\r\n    const [isProcessing, setIsProcessing] = useState(false)\r\n    const [excelData, setExcelData] = useState<ExcelData | null>(null)\r\n    const [error, setError] = useState<string | null>(null)\r\n    const [showMesSelector, setShowMesSelector] = useState(false)\r\n    const [mesDetectado, setMesDetectado] = useState<number | null>(null)\r\n    const [anioDetectado, setAnioDetectado] = useState<number | null>(null)\r\n    const [mesSeleccionado, setMesSeleccionado] = useState(new Date().getMonth() + 1)\r\n    const [anioSeleccionado, setAnioSeleccionado] = useState(new Date().getFullYear())\r\n    const [archivoActual, setArchivoActual] = useState<File | null>(null)\r\n    const [isGuardando, setIsGuardando] = useState(false)\r\n    const [liquidacionActual, setLiquidacionActual] = useState<LiquidacionGuardia | null>(null)\r\n    const [mostrarTablaDetalles, setMostrarTablaDetalles] = useState(false)\r\n    const [notification, setNotification] = useState<{\r\n        isOpen: boolean\r\n        type: NotificationType\r\n        title?: string\r\n        message: string\r\n    }>({\r\n        isOpen: false,\r\n        type: 'info',\r\n        message: ''\r\n    })\r\n\r\n    function showNotification(type: NotificationType, message: string, title?: string) {\r\n        setNotification({\r\n            isOpen: true,\r\n            type,\r\n            message,\r\n            title\r\n        })\r\n        setTimeout(() => {\r\n            setNotification(prev => ({ ...prev, isOpen: false }))\r\n        }, 5000)\r\n    }\r\n\r\n    // Funci√≥n para detectar mes y a√±o desde las fechas del Excel\r\n    const detectarMesAnio = (data: ExcelData): { mes: number | null; anio: number | null } => {\r\n        // Primero intentar desde el per√≠odo\r\n        if (data.periodo?.desde) {\r\n            const partes = data.periodo.desde.split('/')\r\n            if (partes.length === 3) {\r\n                const mes = parseInt(partes[1], 10)\r\n                const anio = parseInt(partes[2], 10)\r\n                if (mes >= 1 && mes <= 12 && anio >= 2020) {\r\n                    return { mes, anio }\r\n                }\r\n            }\r\n        }\r\n\r\n        // Si no hay per√≠odo, buscar en las fechas de las filas\r\n        const fechaColumn = data.headers.find(h => \r\n            h.toLowerCase().includes('fecha') || \r\n            h.toLowerCase().includes('date')\r\n        )\r\n\r\n        if (fechaColumn && data.rows.length > 0) {\r\n            const fechas: number[] = []\r\n            data.rows.forEach(row => {\r\n                const fechaStr = row[fechaColumn]\r\n                if (fechaStr) {\r\n                    // Intentar parsear fecha en formato DD/MM/YYYY\r\n                    if (typeof fechaStr === 'string') {\r\n                        const match = fechaStr.match(/(\\d{1,2})\\/(\\d{1,2})\\/(\\d{4})/)\r\n                        if (match) {\r\n                            const mes = parseInt(match[2], 10)\r\n                            const anio = parseInt(match[3], 10)\r\n                            if (mes >= 1 && mes <= 12 && anio >= 2020) {\r\n                                fechas.push(mes)\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            })\r\n\r\n            // Si todas las fechas son del mismo mes, usar ese mes\r\n            if (fechas.length > 0) {\r\n                const mesComun = fechas[0]\r\n                const todasIguales = fechas.every(m => m === mesComun)\r\n                if (todasIguales) {\r\n                    // Obtener a√±o de la primera fecha\r\n                    const primeraFecha = data.rows[0][fechaColumn]\r\n                    if (typeof primeraFecha === 'string') {\r\n                        const match = primeraFecha.match(/(\\d{1,2})\\/(\\d{1,2})\\/(\\d{4})/)\r\n                        if (match) {\r\n                            return { mes: mesComun, anio: parseInt(match[3], 10) }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return { mes: null, anio: null }\r\n    }\r\n\r\n    const handleUpload = async (file: File) => {\r\n        setIsProcessing(true)\r\n        setExcelData(null)\r\n        setError(null)\r\n        setMesDetectado(null)\r\n        setAnioDetectado(null)\r\n        setArchivoActual(file)\r\n\r\n        try {\r\n            const data = await readExcelFile(file)\r\n            setExcelData(data)\r\n            \r\n            // Detectar mes y a√±o autom√°ticamente\r\n            const { mes, anio } = detectarMesAnio(data)\r\n            if (mes && anio) {\r\n                setMesDetectado(mes)\r\n                setAnioDetectado(anio)\r\n                setMesSeleccionado(mes)\r\n                setAnioSeleccionado(anio)\r\n                // Mostrar modal para confirmar\r\n                setShowMesSelector(true)\r\n            } else {\r\n                // Si no se detect√≥, mostrar modal para seleccionar manualmente\r\n                setShowMesSelector(true)\r\n            }\r\n        } catch (err: any) {\r\n            console.error('Error processing file:', err)\r\n            setError(err.message || 'Ocurri√≥ un error inesperado al procesar el archivo.')\r\n        } finally {\r\n            setIsProcessing(false)\r\n        }\r\n    }\r\n\r\n    const handleMesConfirmado = async (mes: number, anio: number) => {\r\n        setMesSeleccionado(mes)\r\n        setAnioSeleccionado(anio)\r\n        setShowMesSelector(false)\r\n\r\n        // Si hay datos del Excel, procesar y guardar\r\n        if (excelData && archivoActual) {\r\n            setIsGuardando(true)\r\n            try {\r\n                const resultado = await procesarExcelGinecologia(\r\n                    excelData,\r\n                    mes,\r\n                    anio,\r\n                    archivoActual.name\r\n                )\r\n\r\n                if (resultado.errores.length > 0) {\r\n                    const mensajeError = resultado.errores.length > 0 \r\n                        ? `Se procesaron ${resultado.procesadas} filas. Errores: ${resultado.errores.slice(0, 3).join('; ')}${resultado.errores.length > 3 ? '...' : ''}`\r\n                        : `Se procesaron ${resultado.procesadas} filas. Errores: ${resultado.errores.length}`\r\n                    showNotification(\r\n                        'error',\r\n                        mensajeError,\r\n                        'Procesamiento con errores'\r\n                    )\r\n                    console.error('Errores completos:', resultado.errores)\r\n                } else {\r\n                    // Cargar la liquidaci√≥n guardada\r\n                    if (resultado.liquidacionId) {\r\n                        const { data: liquidacionData } = await supabase\r\n                            .from('liquidaciones_guardia')\r\n                            .select('*')\r\n                            .eq('id', resultado.liquidacionId)\r\n                            .single()\r\n                        \r\n                        if (liquidacionData) {\r\n                            const liquidacion = liquidacionData as LiquidacionGuardia\r\n                            setLiquidacionActual(liquidacion)\r\n                            // NO ocultar ExcelDataTable, mantenerlo visible para revisi√≥n\r\n                        }\r\n                    }\r\n\r\n                    if (resultado.advertencias.length > 0) {\r\n                        showNotification(\r\n                            'warning',\r\n                            `Se procesaron ${resultado.procesadas} de ${resultado.totalFilas} filas. ${resultado.advertencias.length} advertencias. Revisa los datos en la tabla.`,\r\n                            'Procesamiento completado'\r\n                        )\r\n                    } else {\r\n                        showNotification(\r\n                            'success',\r\n                            `Se procesaron y guardaron ${resultado.procesadas} consultas. Revisa y edita los datos en la tabla.`,\r\n                            'Guardado exitoso'\r\n                        )\r\n                    }\r\n                }\r\n            } catch (err: any) {\r\n                console.error('Error guardando datos:', err)\r\n                showNotification(\r\n                    'error',\r\n                    `Error al guardar: ${err.message || 'Error desconocido'}`,\r\n                    'Error'\r\n                )\r\n            } finally {\r\n                setIsGuardando(false)\r\n            }\r\n        }\r\n    }\r\n\r\n    // Cargar liquidaci√≥n existente al montar (si hay una en progreso)\r\n    useEffect(() => {\r\n        async function cargarLiquidacionEnProgreso() {\r\n            try {\r\n                const { data, error } = await supabase\r\n                    .from('liquidaciones_guardia')\r\n                    .select('*')\r\n                    .eq('especialidad', 'Ginecolog√≠a')\r\n                    .in('estado', ['pendiente_revision', 'revisado', 'listo_para_liquidar', 'finalizada'])\r\n                    .order('created_at', { ascending: false })\r\n                    .limit(1)\r\n                    .single()\r\n\r\n                if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned\r\n                    console.error('Error cargando liquidaci√≥n:', error)\r\n                    return\r\n                }\r\n\r\n                if (data) {\r\n                    const liquidacion = data as LiquidacionGuardia\r\n                    setLiquidacionActual(liquidacion)\r\n                    setMesSeleccionado(liquidacion.mes)\r\n                    setAnioSeleccionado(liquidacion.anio)\r\n                    // Cargar ExcelData desde los detalles guardados si es necesario\r\n                    // Por ahora, solo cargar la liquidaci√≥n para mostrar el estado\r\n                }\r\n            } catch (error) {\r\n                console.error('Error cargando liquidaci√≥n:', error)\r\n            }\r\n        }\r\n\r\n        cargarLiquidacionEnProgreso()\r\n    }, [])\r\n\r\n    // Extraer mes y a√±o del per√≠odo del Excel (usar el seleccionado)\r\n    const obtenerMesAnio = () => {\r\n        return { mes: mesSeleccionado, anio: anioSeleccionado }\r\n    }\r\n\r\n    // Mapa para guardar cambios pendientes (debounce)\r\n    const cambiosPendientesRef = useRef<Map<string, { liquidacionId: string; filaExcel: number; columna: string; valor: any }>>(new Map())\r\n    const saveTimerRef = useRef<NodeJS.Timeout | null>(null)\r\n    const [saveStatus, setSaveStatus] = useState<'idle' | 'saving' | 'saved' | 'error'>('idle')\r\n\r\n    const handleCellUpdate = async (rowIndex: number, column: string, newValue: any) => {\r\n        if (!liquidacionActual || !excelData) return\r\n\r\n        // El rowIndex en ExcelDataTable corresponde a la fila del Excel (empezando en 0)\r\n        // Pero fila_excel en la BD es el n√∫mero de fila real del Excel (empezando en 1)\r\n        const filaExcel = rowIndex + 1\r\n\r\n        // Guardar cambio pendiente\r\n        const key = `${liquidacionActual.id}-${filaExcel}-${column}`\r\n        cambiosPendientesRef.current.set(key, {\r\n            liquidacionId: liquidacionActual.id,\r\n            filaExcel,\r\n            columna: column,\r\n            valor: newValue\r\n        })\r\n\r\n        // Cancelar timer anterior\r\n        if (saveTimerRef.current) {\r\n            clearTimeout(saveTimerRef.current)\r\n        }\r\n\r\n        // Programar guardado autom√°tico (500ms de debounce)\r\n        saveTimerRef.current = setTimeout(async () => {\r\n            await guardarCambiosPendientes()\r\n        }, 500)\r\n    }\r\n\r\n    const guardarCambiosPendientes = async () => {\r\n        if (cambiosPendientesRef.current.size === 0) return\r\n\r\n        setSaveStatus('saving')\r\n        const cambios = Array.from(cambiosPendientesRef.current.values())\r\n\r\n        try {\r\n            // Agrupar cambios por fila\r\n            const cambiosPorFila = new Map<number, Map<string, any>>()\r\n            cambios.forEach(cambio => {\r\n                if (!cambiosPorFila.has(cambio.filaExcel)) {\r\n                    cambiosPorFila.set(cambio.filaExcel, new Map())\r\n                }\r\n                const filaCambios = cambiosPorFila.get(cambio.filaExcel)!\r\n                \r\n                // Mapear nombre de columna del Excel a campo de BD\r\n                if (cambio.columna.toLowerCase().includes('cliente') || cambio.columna.toLowerCase().includes('obra')) {\r\n                    filaCambios.set('obra_social', cambio.valor)\r\n                } else if (cambio.columna.toLowerCase().includes('responsable') || cambio.columna.toLowerCase().includes('medico')) {\r\n                    filaCambios.set('medico_nombre', cambio.valor)\r\n                } else if (cambio.columna.toLowerCase().includes('paciente')) {\r\n                    filaCambios.set('paciente', cambio.valor)\r\n                }\r\n            })\r\n\r\n            // Guardar cada fila\r\n            const promesas = Array.from(cambiosPorFila.entries()).map(async ([filaExcel, campos]) => {\r\n                const updateData: any = {}\r\n                campos.forEach((valor, campo) => {\r\n                    updateData[campo] = valor\r\n                })\r\n                updateData.updated_at = new Date().toISOString()\r\n\r\n                const { error } = await supabase\r\n                    .from('detalle_guardia')\r\n                    // @ts-ignore\r\n                    .update(updateData)\r\n                    .eq('liquidacion_id', liquidacionActual!.id)\r\n                    .eq('fila_excel', filaExcel)\r\n\r\n                if (error) throw error\r\n            })\r\n\r\n            await Promise.all(promesas)\r\n\r\n            // Limpiar cambios pendientes\r\n            cambiosPendientesRef.current.clear()\r\n            setSaveStatus('saved')\r\n\r\n            // Resetear estado despu√©s de 2 segundos\r\n            setTimeout(() => {\r\n                setSaveStatus('idle')\r\n            }, 2000)\r\n        } catch (error) {\r\n            console.error('Error guardando cambios:', error)\r\n            setSaveStatus('error')\r\n            \r\n            // Reintentar despu√©s de 3 segundos\r\n            setTimeout(() => {\r\n                if (cambiosPendientesRef.current.size > 0) {\r\n                    guardarCambiosPendientes()\r\n                }\r\n            }, 3000)\r\n        }\r\n    }\r\n\r\n    // Guardar antes de desmontar\r\n    useEffect(() => {\r\n        return () => {\r\n            if (saveTimerRef.current) {\r\n                clearTimeout(saveTimerRef.current)\r\n            }\r\n            if (cambiosPendientesRef.current.size > 0) {\r\n                guardarCambiosPendientes()\r\n            }\r\n        }\r\n    }, [])\r\n\r\n    // Guardar antes de cerrar/recargar\r\n    useEffect(() => {\r\n        const handleBeforeUnload = (e: BeforeUnloadEvent) => {\r\n            if (cambiosPendientesRef.current.size > 0) {\r\n                e.preventDefault()\r\n                e.returnValue = 'Tienes cambios sin guardar. ¬øEst√°s seguro de que quieres salir?'\r\n                guardarCambiosPendientes()\r\n            }\r\n        }\r\n\r\n        window.addEventListener('beforeunload', handleBeforeUnload)\r\n        return () => window.removeEventListener('beforeunload', handleBeforeUnload)\r\n    }, [])\r\n\r\n    // Guardado peri√≥dico cada 10 segundos\r\n    useEffect(() => {\r\n        const interval = setInterval(() => {\r\n            if (cambiosPendientesRef.current.size > 0) {\r\n                guardarCambiosPendientes()\r\n            }\r\n        }, 10000)\r\n\r\n        return () => clearInterval(interval)\r\n    }, [])\r\n\r\n    return (\r\n        <div className=\"min-h-screen relative p-8 pb-20 overflow-hidden\">\r\n            {/* Efectos de luz verde */}\r\n            <div className=\"absolute top-20 left-20 w-96 h-96 bg-green-500/20 rounded-full blur-3xl animate-pulse\"></div>\r\n            <div className=\"absolute bottom-20 right-20 w-96 h-96 bg-green-400/20 rounded-full blur-3xl animate-pulse delay-1000\"></div>\r\n\r\n            <div className=\"max-w-6xl mx-auto space-y-8 relative z-10\">\r\n                {/* Header con Logo */}\r\n                <div className=\"flex items-center justify-between mb-8\">\r\n                    <div className=\"flex items-center gap-4\">\r\n                        <Button\r\n                            onClick={() => router.push('/')}\r\n                            variant=\"outline\"\r\n                            className=\"border-green-500/50 text-green-400 hover:bg-green-500/20\"\r\n                        >\r\n                            <ArrowLeft className=\"h-4 w-4 mr-2\" />\r\n                            Volver\r\n                        </Button>\r\n                    </div>\r\n                    <div>\r\n                        <div className=\"flex items-center gap-4 mb-4\">\r\n                            <Link href=\"/\" className=\"hover:opacity-80 transition-opacity\">\r\n                                <img \r\n                                    src=\"/logogrow.png\" \r\n                                    alt=\"Grow Labs\" \r\n                                    className=\"h-16 w-auto drop-shadow-2xl\"\r\n                                    style={{\r\n                                        filter: 'drop-shadow(0 0 20px rgba(34, 197, 94, 0.5))'\r\n                                    }}\r\n                                />\r\n                            </Link>\r\n                            <div>\r\n                                <h1 className=\"text-4xl font-bold mb-2 tracking-tight\">\r\n                                    <span className=\"bg-gradient-to-r from-blue-400 to-cyan-300 bg-clip-text text-transparent\">\r\n                                        M√≥dulo Ginecolog√≠a\r\n                                    </span>\r\n                                </h1>\r\n                                <p className=\"text-gray-400 flex items-center gap-2\">\r\n                                    <Sparkles className=\"h-4 w-4 text-blue-400\" />\r\n                                    Procesamiento de liquidaciones por hora\r\n                                </p>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Upload Excel Card */}\r\n                <div \r\n                    className=\"relative rounded-2xl shadow-2xl overflow-hidden p-8\"\r\n                    style={{\r\n                        background: 'rgba(255, 255, 255, 0.1)',\r\n                        backdropFilter: 'blur(20px)',\r\n                        border: '1px solid rgba(59, 130, 246, 0.3)',\r\n                        boxShadow: '0 8px 32px 0 rgba(59, 130, 246, 0.3)',\r\n                    }}\r\n                >\r\n                    {/* Borde brillante animado */}\r\n                    <div \r\n                        className=\"absolute inset-0 rounded-2xl\"\r\n                        style={{\r\n                            background: 'linear-gradient(45deg, transparent, rgba(59, 130, 246, 0.3), transparent)',\r\n                            animation: 'borderGlow 3s ease-in-out infinite',\r\n                        }}\r\n                    ></div>\r\n                    <div className=\"relative\">\r\n                        <div className=\"flex items-center justify-between mb-6\">\r\n                            <h2 className=\"text-2xl font-bold text-blue-400\">\r\n                                üì§ Cargar Liquidaci√≥n\r\n                            </h2>\r\n                            <Button\r\n                                onClick={() => router.push('/ginecologia/resumenes')}\r\n                                variant=\"outline\"\r\n                                className=\"border-blue-500/50 text-blue-400 hover:bg-blue-500/20\"\r\n                            >\r\n                                Ver Res√∫menes\r\n                            </Button>\r\n                        </div>\r\n\r\n                    <UploadExcel onUpload={handleUpload} isProcessing={isProcessing} />\r\n\r\n                    {/* Mensaje de error */}\r\n                    {error && (\r\n                        <div className=\"mt-6 bg-red-500/10 border border-red-500/30 rounded-lg p-4 flex items-start gap-3 text-red-400\">\r\n                            <AlertCircle className=\"w-5 h-5 mt-0.5 shrink-0\" />\r\n                            <div>\r\n                                <h3 className=\"font-semibold\">Error de Procesamiento</h3>\r\n                                <p className=\"text-sm opacity-90\">{error}</p>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Selector de estado y barra de guardado (si hay liquidaci√≥n) */}\r\n                {liquidacionActual && (\r\n                    <div \r\n                        className=\"relative rounded-2xl shadow-2xl overflow-hidden p-6\"\r\n                        style={{\r\n                            background: 'rgba(255, 255, 255, 0.1)',\r\n                            backdropFilter: 'blur(20px)',\r\n                            border: '1px solid rgba(59, 130, 246, 0.3)',\r\n                            boxShadow: '0 8px 32px 0 rgba(59, 130, 246, 0.3)',\r\n                        }}\r\n                    >\r\n                        <div className=\"flex items-center justify-between\">\r\n                            <div className=\"flex items-center gap-4\">\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    {saveStatus === 'saving' && (\r\n                                        <>\r\n                                            <Clock className=\"h-4 w-4 text-yellow-400 animate-spin\" />\r\n                                            <span className=\"text-sm text-yellow-400\">Guardando...</span>\r\n                                        </>\r\n                                    )}\r\n                                    {saveStatus === 'saved' && (\r\n                                        <>\r\n                                            <CheckCircle2 className=\"h-4 w-4 text-green-400\" />\r\n                                            <span className=\"text-sm text-green-400\">Guardado</span>\r\n                                        </>\r\n                                    )}\r\n                                    {saveStatus === 'error' && (\r\n                                        <>\r\n                                            <AlertCircle className=\"h-4 w-4 text-red-400\" />\r\n                                            <span className=\"text-sm text-red-400\">Error al guardar. Reintentando...</span>\r\n                                        </>\r\n                                    )}\r\n                                    {saveStatus === 'idle' && cambiosPendientesRef.current.size > 0 && (\r\n                                        <span className=\"text-sm text-gray-400\">\r\n                                            {cambiosPendientesRef.current.size} cambio(s) pendiente(s)\r\n                                        </span>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"flex items-center gap-4\">\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    <label className=\"text-sm text-gray-300\">Estado:</label>\r\n                                    <select\r\n                                        value={liquidacionActual.estado}\r\n                                        onChange={async (e) => {\r\n                                            const nuevoEstado = e.target.value as EstadoLiquidacion\r\n                                            try {\r\n                                                const { error } = await supabase\r\n                                                    .from('liquidaciones_guardia')\r\n                                                    // @ts-ignore\r\n                                                    .update({ estado: nuevoEstado })\r\n                                                    .eq('id', liquidacionActual.id)\r\n\r\n                                                if (error) throw error\r\n                                                setLiquidacionActual(prev => prev ? { ...prev, estado: nuevoEstado } : null)\r\n                                            } catch (error) {\r\n                                                console.error('Error actualizando estado:', error)\r\n                                                showNotification('error', 'Error al actualizar el estado', 'Error')\r\n                                            }\r\n                                        }}\r\n                                        className=\"px-3 py-1 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:border-green-400 focus:outline-none\"\r\n                                    >\r\n                                        <option value=\"borrador\">Borrador</option>\r\n                                        <option value=\"procesando\">Procesando</option>\r\n                                        <option value=\"pendiente_revision\">Pendiente de Revisi√≥n</option>\r\n                                        <option value=\"revisado\">Revisado</option>\r\n                                        <option value=\"listo_para_liquidar\">Listo para Liquidar</option>\r\n                                        <option value=\"finalizada\">Finalizada</option>\r\n                                    </select>\r\n                                </div>\r\n                                {cambiosPendientesRef.current.size > 0 && (\r\n                                    <Button\r\n                                        onClick={() => guardarCambiosPendientes()}\r\n                                        size=\"sm\"\r\n                                        className=\"bg-green-600 hover:bg-green-500\"\r\n                                    >\r\n                                        Guardar ahora\r\n                                    </Button>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Tabla de datos del Excel (mostrar siempre despu√©s de procesar) */}\r\n                {excelData && (\r\n                    <div \r\n                        className=\"relative rounded-2xl shadow-2xl overflow-hidden p-8\"\r\n                        style={{\r\n                            background: 'rgba(255, 255, 255, 0.1)',\r\n                            backdropFilter: 'blur(20px)',\r\n                            border: '1px solid rgba(59, 130, 246, 0.3)',\r\n                            boxShadow: '0 8px 32px 0 rgba(59, 130, 246, 0.3)',\r\n                        }}\r\n                    >\r\n                        <div className=\"relative\">\r\n                            <h2 className=\"text-2xl font-bold text-blue-400 mb-6\">\r\n                                üìä Datos del Excel - Revisi√≥n y Edici√≥n\r\n                            </h2>\r\n                            {liquidacionActual && (\r\n                                <p className=\"text-gray-400 mb-4 text-sm\">\r\n                                    Los cambios se guardan autom√°ticamente. Revisa duplicados, filas sin obra social y sin horario.\r\n                                </p>\r\n                            )}\r\n                            <ExcelDataTable\r\n                                data={excelData}\r\n                                especialidad=\"Ginecolog√≠a\"\r\n                                onCellUpdate={handleCellUpdate}\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Estad√≠sticas por Obra Social */}\r\n                {excelData && excelData.periodo && (() => {\r\n                    const { mes, anio } = obtenerMesAnio()\r\n                    return (\r\n                        <div \r\n                            className=\"relative rounded-2xl shadow-2xl overflow-hidden p-8\"\r\n                            style={{\r\n                                background: 'rgba(255, 255, 255, 0.1)',\r\n                                backdropFilter: 'blur(20px)',\r\n                                border: '1px solid rgba(59, 130, 246, 0.3)',\r\n                                boxShadow: '0 8px 32px 0 rgba(59, 130, 246, 0.3)',\r\n                            }}\r\n                        >\r\n                            <EstadisticasObraSocial\r\n                                mes={mes}\r\n                                anio={anio}\r\n                                especialidad=\"Ginecolog√≠a\"\r\n                            />\r\n                        </div>\r\n                    )\r\n                })()}\r\n\r\n                {/* Reglas de Negocio */}\r\n                <div \r\n                    className=\"p-6 rounded-xl\"\r\n                    style={{\r\n                        background: 'rgba(255, 255, 255, 0.1)',\r\n                        backdropFilter: 'blur(20px)',\r\n                        border: '1px solid rgba(255, 255, 255, 0.2)',\r\n                        boxShadow: '0 8px 32px 0 rgba(59, 130, 246, 0.2)',\r\n                    }}\r\n                >\r\n                        <h3 className=\"text-xl font-semibold text-gray-200 mb-4\">\r\n                            üìã Reglas Vigentes\r\n                        </h3>\r\n                        <div className=\"space-y-4 text-sm text-gray-300\">\r\n                            <div className=\"p-3 bg-white/5 rounded-lg border border-white/5\">\r\n                                <div className=\"text-xs text-gray-500 uppercase tracking-wider mb-1\">Pago por Hora</div>\r\n                                <div className=\"font-semibold text-white\">Seg√∫n Tarifa</div>\r\n                                <div className=\"text-xs text-gray-400\">Valor hora vigente por obra social</div>\r\n                            </div>\r\n\r\n                            <div className=\"p-3 bg-white/5 rounded-lg border border-white/5\">\r\n                                <div className=\"text-xs text-gray-500 uppercase tracking-wider mb-1\">üë®‚Äç‚öïÔ∏è Regla de Residentes en Horario Formativo</div>\r\n                                <div className=\"text-sm mt-2 space-y-2\">\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <span className=\"text-red-400 font-semibold\">NO SE PAGA</span>\r\n                                        <span className=\"text-xs text-gray-400\">si se cumplen todas las condiciones:</span>\r\n                                    </div>\r\n                                    <ul className=\"text-xs space-y-1 ml-2 text-gray-300\">\r\n                                        <li className=\"flex items-start gap-2\">\r\n                                            <span className=\"text-blue-400\">‚Ä¢</span>\r\n                                            <span>M√©dico es <strong>RESIDENTE</strong> (verificado en BD)</span>\r\n                                        </li>\r\n                                        <li className=\"flex items-start gap-2\">\r\n                                            <span className=\"text-blue-400\">‚Ä¢</span>\r\n                                            <span>D√≠a: <strong>Lunes a S√°bado</strong> (no domingo)</span>\r\n                                        </li>\r\n                                        <li className=\"flex items-start gap-2\">\r\n                                            <span className=\"text-blue-400\">‚Ä¢</span>\r\n                                            <span>Horario: <strong className=\"text-blue-400\">07:00 a 15:00</strong></span>\r\n                                        </li>\r\n                                        <li className=\"text-xs text-gray-400 mt-1 ml-4\">\r\n                                            (Incluye 07:00, excluye 15:00)\r\n                                        </li>\r\n                                    </ul>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"p-3 bg-white/5 rounded-lg border border-white/5\">\r\n                                <div className=\"text-xs text-gray-500 uppercase tracking-wider mb-1\">‚úÖ Casos que S√ç se Pagan</div>\r\n                                <ul className=\"text-xs space-y-1 mt-2 text-gray-300\">\r\n                                    <li className=\"flex items-start gap-2\">\r\n                                        <span className=\"text-green-400\">‚úì</span>\r\n                                        <span>Residente fuera del horario formativo (ej: 16:00, 20:00)</span>\r\n                                    </li>\r\n                                    <li className=\"flex items-start gap-2\">\r\n                                        <span className=\"text-green-400\">‚úì</span>\r\n                                        <span>Residente en <strong>Domingo</strong> (cualquier hora)</span>\r\n                                    </li>\r\n                                    <li className=\"flex items-start gap-2\">\r\n                                        <span className=\"text-green-400\">‚úì</span>\r\n                                        <span>M√©dico de <strong>Planta</strong> (no residente) - siempre se paga</span>\r\n                                    </li>\r\n                                </ul>\r\n                            </div>\r\n\r\n                            <div className=\"p-3 bg-white/5 rounded-lg border border-white/5\">\r\n                                <div className=\"text-xs text-gray-500 uppercase tracking-wider mb-1\">üìä Ejemplos de Horarios</div>\r\n                                <div className=\"text-xs space-y-1 mt-2\">\r\n                                    <div className=\"flex justify-between\">\r\n                                        <span className=\"text-gray-300\">07:00 (Residente, L-S)</span>\r\n                                        <span className=\"text-red-400\">$0</span>\r\n                                    </div>\r\n                                    <div className=\"flex justify-between\">\r\n                                        <span className=\"text-gray-300\">14:59 (Residente, L-S)</span>\r\n                                        <span className=\"text-red-400\">$0</span>\r\n                                    </div>\r\n                                    <div className=\"flex justify-between\">\r\n                                        <span className=\"text-gray-300\">15:00 (Residente, L-S)</span>\r\n                                        <span className=\"text-green-400\">Se paga</span>\r\n                                    </div>\r\n                                    <div className=\"flex justify-between\">\r\n                                        <span className=\"text-gray-300\">10:00 (Residente, Domingo)</span>\r\n                                        <span className=\"text-green-400\">Se paga</span>\r\n                                    </div>\r\n                                    <div className=\"flex justify-between\">\r\n                                        <span className=\"text-gray-300\">10:00 (Planta, cualquier d√≠a)</span>\r\n                                        <span className=\"text-green-400\">Se paga</span>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n            </div>\r\n\r\n            {/* Modal de selecci√≥n de mes */}\r\n            <MesSelectorModal\r\n                isOpen={showMesSelector}\r\n                onClose={() => setShowMesSelector(false)}\r\n                onConfirm={handleMesConfirmado}\r\n                mesDetectado={mesDetectado}\r\n                anioDetectado={anioDetectado}\r\n                mesActual={new Date().getMonth() + 1}\r\n                anioActual={new Date().getFullYear()}\r\n            />\r\n\r\n            {/* Notificaci√≥n */}\r\n            <NotificationModal\r\n                isOpen={notification.isOpen}\r\n                onClose={() => setNotification(prev => ({ ...prev, isOpen: false }))}\r\n                type={notification.type}\r\n                title={notification.title}\r\n                message={notification.message}\r\n            />\r\n\r\n            {/* Indicador de guardado */}\r\n            {isGuardando && (\r\n                <div className=\"fixed bottom-4 right-4 p-4 rounded-lg bg-blue-500/20 border border-blue-500/50 text-blue-400\">\r\n                    Guardando datos en la base de datos...\r\n                </div>\r\n            )}\r\n        </div>\r\n    )\r\n}\r\n","'use client'\r\n\r\nimport { useState, useEffect } from 'react'\r\nimport { Button } from '@/components/ui/button'\r\nimport { X } from 'lucide-react'\r\n\r\ninterface MesSelectorModalProps {\r\n  isOpen: boolean\r\n  onClose: () => void\r\n  onConfirm: (mes: number, anio: number) => void\r\n  mesDetectado: number | null\r\n  anioDetectado: number | null\r\n  mesActual: number\r\n  anioActual: number\r\n}\r\n\r\nconst MESES = [\r\n  { value: 1, label: 'Enero' },\r\n  { value: 2, label: 'Febrero' },\r\n  { value: 3, label: 'Marzo' },\r\n  { value: 4, label: 'Abril' },\r\n  { value: 5, label: 'Mayo' },\r\n  { value: 6, label: 'Junio' },\r\n  { value: 7, label: 'Julio' },\r\n  { value: 8, label: 'Agosto' },\r\n  { value: 9, label: 'Septiembre' },\r\n  { value: 10, label: 'Octubre' },\r\n  { value: 11, label: 'Noviembre' },\r\n  { value: 12, label: 'Diciembre' },\r\n]\r\n\r\nexport function MesSelectorModal({\r\n  isOpen,\r\n  onClose,\r\n  onConfirm,\r\n  mesDetectado,\r\n  anioDetectado,\r\n  mesActual,\r\n  anioActual\r\n}: MesSelectorModalProps) {\r\n  const [mes, setMes] = useState(mesDetectado || mesActual)\r\n  const [anio, setAnio] = useState(anioDetectado || anioActual)\r\n\r\n  useEffect(() => {\r\n    if (isOpen) {\r\n      setMes(mesDetectado || mesActual)\r\n      setAnio(anioDetectado || anioActual)\r\n    }\r\n  }, [isOpen, mesDetectado, anioDetectado, mesActual, anioActual])\r\n\r\n  if (!isOpen) return null\r\n\r\n  const handleConfirm = () => {\r\n    onConfirm(mes, anio)\r\n    onClose()\r\n  }\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center\">\r\n      {/* Backdrop */}\r\n      <div \r\n        className=\"absolute inset-0 bg-black/70 backdrop-blur-sm\"\r\n        onClick={onClose}\r\n      />\r\n      \r\n      {/* Modal */}\r\n      <div \r\n        className=\"relative z-10 w-full max-w-md mx-4 rounded-2xl p-6\"\r\n        style={{\r\n          background: 'rgba(17, 24, 39, 0.95)',\r\n          backdropFilter: 'blur(20px)',\r\n          border: '1px solid rgba(34, 197, 94, 0.3)',\r\n          boxShadow: '0 8px 32px 0 rgba(34, 197, 94, 0.3)',\r\n        }}\r\n      >\r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between mb-6\">\r\n          <h2 className=\"text-2xl font-bold text-green-400\">\r\n            Seleccionar Per√≠odo\r\n          </h2>\r\n          <button\r\n            onClick={onClose}\r\n            className=\"p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition-colors\"\r\n          >\r\n            <X className=\"h-5 w-5\" />\r\n          </button>\r\n        </div>\r\n\r\n        {/* Contenido */}\r\n        <div className=\"space-y-6\">\r\n          {/* Detecci√≥n autom√°tica */}\r\n          {mesDetectado && anioDetectado && (\r\n            <div \r\n              className=\"p-4 rounded-lg\"\r\n              style={{\r\n                background: 'rgba(34, 197, 94, 0.1)',\r\n                border: '1px solid rgba(34, 197, 94, 0.3)',\r\n              }}\r\n            >\r\n              <p className=\"text-sm text-green-400 mb-2\">\r\n                ‚úì Mes detectado autom√°ticamente\r\n              </p>\r\n              <p className=\"text-sm text-gray-300\">\r\n                {MESES[mesDetectado - 1].label} {anioDetectado}\r\n              </p>\r\n            </div>\r\n          )}\r\n\r\n          {/* Selector de Mes */}\r\n          <div>\r\n            <label className=\"block text-sm font-semibold text-gray-300 mb-2\">\r\n              Mes\r\n            </label>\r\n            <select\r\n              value={mes}\r\n              onChange={(e) => setMes(Number(e.target.value))}\r\n              className=\"w-full px-4 py-2 bg-gray-800 border border-green-500/50 rounded-lg text-white focus:border-green-400 focus:outline-none\"\r\n            >\r\n              {MESES.map(m => (\r\n                <option key={m.value} value={m.value}>\r\n                  {m.label}\r\n                </option>\r\n              ))}\r\n            </select>\r\n          </div>\r\n\r\n          {/* Selector de A√±o */}\r\n          <div>\r\n            <label className=\"block text-sm font-semibold text-gray-300 mb-2\">\r\n              A√±o\r\n            </label>\r\n            <input\r\n              type=\"number\"\r\n              value={anio}\r\n              onChange={(e) => setAnio(Number(e.target.value))}\r\n              min={2020}\r\n              max={2100}\r\n              className=\"w-full px-4 py-2 bg-gray-800 border border-green-500/50 rounded-lg text-white focus:border-green-400 focus:outline-none\"\r\n            />\r\n          </div>\r\n\r\n          {/* Botones */}\r\n          <div className=\"flex gap-3 pt-4\">\r\n            <Button\r\n              onClick={onClose}\r\n              variant=\"outline\"\r\n              className=\"flex-1 border-gray-600 text-gray-300 hover:bg-gray-700\"\r\n            >\r\n              Cancelar\r\n            </Button>\r\n            <Button\r\n              onClick={handleConfirm}\r\n              className=\"flex-1 bg-green-600 hover:bg-green-500 text-white\"\r\n            >\r\n              Confirmar\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","import { supabase } from './supabase/client'\r\nimport { ExcelData, ExcelRow } from './excel-reader'\r\nimport { Medico, DetalleGuardiaInsert, LiquidacionGuardiaInsert, ValorConsultaObraSocial } from './types'\r\nimport { esResidenteHorarioFormativo, horaAMinutos } from './utils'\r\nimport { calcularNumeroLiquidacion } from './utils'\r\n\r\ninterface ProcesamientoResult {\r\n  liquidacionId: string\r\n  totalFilas: number\r\n  procesadas: number\r\n  errores: string[]\r\n  advertencias: string[]\r\n}\r\n\r\n/**\r\n * Normaliza el nombre de una columna para b√∫squeda flexible\r\n */\r\nfunction normalizarColumna(nombre: string): string {\r\n  return nombre\r\n    .toLowerCase()\r\n    .normalize('NFD')\r\n    .replace(/[\\u0300-\\u036f]/g, '')\r\n    .trim()\r\n}\r\n\r\n/**\r\n * Busca un valor en una fila por variaciones del nombre de columna\r\n */\r\nfunction buscarValor(row: ExcelRow, variaciones: string[]): any {\r\n  const keys = Object.keys(row)\r\n  \r\n  // Si no hay keys, retornar null\r\n  if (keys.length === 0) return null\r\n  \r\n  // Buscar coincidencia exacta (case-insensitive)\r\n  for (const variacion of variaciones) {\r\n    for (const key of keys) {\r\n      if (key.toLowerCase().trim() === variacion.toLowerCase().trim()) {\r\n        const valor = row[key]\r\n        if (valor !== undefined && valor !== null) {\r\n          if (typeof valor === 'string' && valor.trim() !== '') return valor.trim()\r\n          if (typeof valor !== 'string') return valor\r\n        }\r\n      }\r\n    }\r\n  }\r\n  \r\n  // Buscar coincidencia normalizada (sin acentos, espacios)\r\n  const normalizadas = variaciones.map(normalizarColumna)\r\n  for (const key of keys) {\r\n    const keyNormalizada = normalizarColumna(key)\r\n    if (normalizadas.includes(keyNormalizada)) {\r\n      const valor = row[key]\r\n      if (valor !== undefined && valor !== null) {\r\n        if (typeof valor === 'string' && valor.trim() !== '') return valor.trim()\r\n        if (typeof valor !== 'string') return valor\r\n      }\r\n    }\r\n  }\r\n  \r\n  // Buscar coincidencia parcial (contiene palabras clave)\r\n  for (const variacion of variaciones) {\r\n    const palabras = normalizarColumna(variacion).split(/\\s+/).filter(p => p.length > 2)\r\n    if (palabras.length === 0) continue\r\n    \r\n    for (const key of keys) {\r\n      const keyNormalizada = normalizarColumna(key)\r\n      // Verificar que todas las palabras importantes est√©n presentes\r\n      const todasPalabrasPresentes = palabras.every(p => keyNormalizada.includes(p))\r\n      if (todasPalabrasPresentes) {\r\n        const valor = row[key]\r\n        if (valor !== undefined && valor !== null) {\r\n          if (typeof valor === 'string' && valor.trim() !== '') return valor.trim()\r\n          if (typeof valor !== 'string') return valor\r\n        }\r\n      }\r\n    }\r\n  }\r\n  \r\n  return null\r\n}\r\n\r\n/**\r\n * Busca un m√©dico por nombre en la lista de m√©dicos\r\n */\r\n/**\r\n * Normaliza un nombre para b√∫squeda (sin acentos, min√∫sculas, sin espacios extra)\r\n */\r\nfunction normalizarNombre(nombre: string): string {\r\n  return nombre\r\n    .toLowerCase()\r\n    .normalize('NFD')\r\n    .replace(/[\\u0300-\\u036f]/g, '')\r\n    .replace(/\\s+/g, ' ')\r\n    .trim()\r\n}\r\n\r\n/**\r\n * Busca un m√©dico por nombre en la lista de m√©dicos\r\n * B√∫squeda muy flexible con m√∫ltiples estrategias\r\n */\r\nfunction buscarMedico(nombre: string | null, medicos: Medico[]): Medico | null {\r\n  if (!nombre || typeof nombre !== 'string') return null\r\n  \r\n  const nombreNormalizado = normalizarNombre(nombre)\r\n  if (nombreNormalizado === '') return null\r\n  \r\n  // Estrategia 1: Coincidencia exacta (despu√©s de normalizar)\r\n  for (const medico of medicos) {\r\n    const medicoNombreNormalizado = normalizarNombre(medico.nombre)\r\n    if (medicoNombreNormalizado === nombreNormalizado) {\r\n      return medico\r\n    }\r\n  }\r\n  \r\n  // Estrategia 2: Coincidencia exacta sin considerar orden (si uno tiene coma y otro no)\r\n  // Ejemplo: \"Garc√≠a, Juan\" vs \"Juan Garc√≠a\"\r\n  const partesNombre = nombreNormalizado.split(',').map(p => p.trim())\r\n  const palabrasNombre = nombreNormalizado.split(/\\s+/).filter(p => p.length > 2)\r\n  \r\n  for (const medico of medicos) {\r\n    const medicoNombreNormalizado = normalizarNombre(medico.nombre)\r\n    const partesMedico = medicoNombreNormalizado.split(',').map(p => p.trim())\r\n    const palabrasMedico = medicoNombreNormalizado.split(/\\s+/).filter(p => p.length > 2)\r\n    \r\n    // Si ambos tienen las mismas palabras (sin importar orden)\r\n    if (palabrasNombre.length > 0 && palabrasMedico.length > 0) {\r\n      const palabrasNombreSet = new Set(palabrasNombre)\r\n      const palabrasMedicoSet = new Set(palabrasMedico)\r\n      \r\n      if (palabrasNombreSet.size === palabrasMedicoSet.size &&\r\n          Array.from(palabrasNombreSet).every(p => palabrasMedicoSet.has(p))) {\r\n        return medico\r\n      }\r\n    }\r\n  }\r\n  \r\n  // Estrategia 3: Buscar por apellido (primera parte antes de la coma o primera palabra)\r\n  const apellidoNombre = partesNombre.length > 1 \r\n    ? partesNombre[0].trim()\r\n    : (palabrasNombre.length > 0 ? palabrasNombre[0] : nombreNormalizado)\r\n  \r\n  // Primero buscar coincidencia exacta de apellido\r\n  let mejorCoincidenciaApellido: Medico | null = null\r\n  let mejorPuntuacionApellido = 0\r\n  \r\n  for (const medico of medicos) {\r\n    const medicoNombreNormalizado = normalizarNombre(medico.nombre)\r\n    const partesMedico = medicoNombreNormalizado.split(',').map(p => p.trim())\r\n    const palabrasMedico = medicoNombreNormalizado.split(/\\s+/).filter(p => p.length > 2)\r\n    \r\n    const apellidoMedico = partesMedico.length > 1\r\n      ? partesMedico[0].trim()\r\n      : (palabrasMedico.length > 0 ? palabrasMedico[0] : medicoNombreNormalizado)\r\n    \r\n    // Coincidencia exacta de apellido (prioridad m√°xima)\r\n    if (apellidoNombre === apellidoMedico && apellidoNombre.length > 2) {\r\n      // Si hay coincidencia exacta, verificar si tambi√©n coinciden m√°s palabras\r\n      const palabrasCoincidentes = palabrasNombre.filter(p => \r\n        palabrasMedico.some(m => m === p || m.includes(p) || p.includes(m))\r\n      ).length\r\n      \r\n      if (palabrasCoincidentes > mejorPuntuacionApellido) {\r\n        mejorPuntuacionApellido = palabrasCoincidentes\r\n        mejorCoincidenciaApellido = medico\r\n      }\r\n    }\r\n  }\r\n  \r\n  // Si encontramos coincidencia exacta de apellido con buena puntuaci√≥n, retornarla\r\n  if (mejorCoincidenciaApellido && mejorPuntuacionApellido > 0) {\r\n    return mejorCoincidenciaApellido\r\n  }\r\n  \r\n  // Si no, buscar coincidencia parcial de apellido\r\n  for (const medico of medicos) {\r\n    const medicoNombreNormalizado = normalizarNombre(medico.nombre)\r\n    const partesMedico = medicoNombreNormalizado.split(',').map(p => p.trim())\r\n    const palabrasMedico = medicoNombreNormalizado.split(/\\s+/).filter(p => p.length > 2)\r\n    \r\n    const apellidoMedico = partesMedico.length > 1\r\n      ? partesMedico[0].trim()\r\n      : (palabrasMedico.length > 0 ? palabrasMedico[0] : medicoNombreNormalizado)\r\n    \r\n    // Coincidencia parcial de apellido (uno contiene al otro)\r\n    if (apellidoNombre.length > 2 && apellidoMedico.length > 2) {\r\n      if (apellidoNombre.includes(apellidoMedico) || apellidoMedico.includes(apellidoNombre)) {\r\n        // Verificar tambi√©n cu√°ntas palabras coinciden\r\n        const palabrasCoincidentes = palabrasNombre.filter(p => \r\n          palabrasMedico.some(m => m === p || m.includes(p) || p.includes(m))\r\n        ).length\r\n        \r\n        if (palabrasCoincidentes >= mejorPuntuacionApellido) {\r\n          mejorPuntuacionApellido = palabrasCoincidentes\r\n          mejorCoincidenciaApellido = medico\r\n        }\r\n      }\r\n    }\r\n  }\r\n  \r\n  if (mejorCoincidenciaApellido) {\r\n    return mejorCoincidenciaApellido\r\n  }\r\n  \r\n  // Estrategia 4: Buscar por todas las palabras importantes (todas deben estar presentes)\r\n  if (palabrasNombre.length > 0) {\r\n    for (const medico of medicos) {\r\n      const medicoNombreNormalizado = normalizarNombre(medico.nombre)\r\n      const palabrasMedico = medicoNombreNormalizado.split(/\\s+/).filter(p => p.length > 2)\r\n      \r\n      // Si todas las palabras del nombre est√°n en el nombre del m√©dico\r\n      if (palabrasNombre.every(p => medicoNombreNormalizado.includes(p))) {\r\n        return medico\r\n      }\r\n      \r\n      // Si todas las palabras del m√©dico est√°n en el nombre\r\n      if (palabrasMedico.length > 0 && palabrasMedico.every(p => nombreNormalizado.includes(p))) {\r\n        return medico\r\n      }\r\n    }\r\n  }\r\n  \r\n  // Estrategia 5: B√∫squeda por similitud (al menos 2 palabras coinciden)\r\n  if (palabrasNombre.length >= 2) {\r\n    let mejorCoincidencia: Medico | null = null\r\n    let mejorPuntuacion = 0\r\n    \r\n    for (const medico of medicos) {\r\n      const medicoNombreNormalizado = normalizarNombre(medico.nombre)\r\n      const palabrasMedico = medicoNombreNormalizado.split(/\\s+/).filter(p => p.length > 2)\r\n      \r\n      // Contar cu√°ntas palabras coinciden\r\n      const palabrasCoincidentes = palabrasNombre.filter(p => \r\n        palabrasMedico.some(m => m.includes(p) || p.includes(m))\r\n      ).length\r\n      \r\n      if (palabrasCoincidentes >= 2 && palabrasCoincidentes > mejorPuntuacion) {\r\n        mejorPuntuacion = palabrasCoincidentes\r\n        mejorCoincidencia = medico\r\n      }\r\n    }\r\n    \r\n    if (mejorCoincidencia) {\r\n      return mejorCoincidencia\r\n    }\r\n  }\r\n  \r\n  return null\r\n}\r\n\r\n/**\r\n * Convierte una fecha en m√∫ltiples formatos a ISO (YYYY-MM-DD)\r\n */\r\nfunction convertirFechaISO(fecha: string | null | undefined): string | null {\r\n  if (!fecha) return null\r\n  \r\n  const fechaStr = String(fecha).trim()\r\n  if (fechaStr === '') return null\r\n  \r\n  // Intentar formato DD/MM/YYYY\r\n  const matchDDMMYYYY = fechaStr.match(/(\\d{1,2})\\/(\\d{1,2})\\/(\\d{4})/)\r\n  if (matchDDMMYYYY) {\r\n    const dia = matchDDMMYYYY[1].padStart(2, '0')\r\n    const mes = matchDDMMYYYY[2].padStart(2, '0')\r\n    const anio = matchDDMMYYYY[3]\r\n    return `${anio}-${mes}-${dia}`\r\n  }\r\n  \r\n  // Intentar formato YYYY-MM-DD (ya est√° en ISO)\r\n  const matchISO = fechaStr.match(/(\\d{4})-(\\d{1,2})-(\\d{1,2})/)\r\n  if (matchISO) {\r\n    const anio = matchISO[1]\r\n    const mes = matchISO[2].padStart(2, '0')\r\n    const dia = matchISO[3].padStart(2, '0')\r\n    return `${anio}-${mes}-${dia}`\r\n  }\r\n  \r\n  // Intentar parsear como Date object\r\n  try {\r\n    const dateObj = new Date(fechaStr)\r\n    if (!isNaN(dateObj.getTime())) {\r\n      const year = dateObj.getFullYear()\r\n      const month = String(dateObj.getMonth() + 1).padStart(2, '0')\r\n      const day = String(dateObj.getDate()).padStart(2, '0')\r\n      return `${year}-${month}-${day}`\r\n    }\r\n  } catch {\r\n    // Ignorar error\r\n  }\r\n  \r\n  return null\r\n}\r\n\r\n/**\r\n * Convierte una hora a formato HH:MM:SS\r\n */\r\nfunction convertirHora(hora: any): string | null {\r\n  if (!hora) return null\r\n  \r\n  if (typeof hora === 'string') {\r\n    // Ya es string, verificar formato\r\n    const match = hora.match(/(\\d{1,2}):(\\d{2})(?::(\\d{2}))?/)\r\n    if (match) {\r\n      const h = match[1].padStart(2, '0')\r\n      const m = match[2].padStart(2, '0')\r\n      const s = match[3] || '00'\r\n      return `${h}:${m}:${s}`\r\n    }\r\n  } else if (typeof hora === 'number') {\r\n    // Es un n√∫mero (serial de Excel), convertir a tiempo\r\n    const totalSegundos = Math.round(hora * 86400) // Excel almacena d√≠as como fracci√≥n\r\n    const horas = Math.floor(totalSegundos / 3600)\r\n    const minutos = Math.floor((totalSegundos % 3600) / 60)\r\n    const segundos = totalSegundos % 60\r\n    return `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}:${String(segundos).padStart(2, '0')}`\r\n  }\r\n  \r\n  return null\r\n}\r\n\r\n/**\r\n * Procesa un Excel de ginecolog√≠a y lo guarda en la base de datos\r\n */\r\nexport async function procesarExcelGinecologia(\r\n  excelData: ExcelData,\r\n  mes: number,\r\n  anio: number,\r\n  archivoNombre: string\r\n): Promise<ProcesamientoResult> {\r\n  const resultado: ProcesamientoResult = {\r\n    liquidacionId: '',\r\n    totalFilas: 0,\r\n    procesadas: 0,\r\n    errores: [],\r\n    advertencias: []\r\n  }\r\n\r\n  try {\r\n    // 1. Cargar TODOS los m√©dicos de ginecolog√≠a (activos e inactivos)\r\n    const { data: medicosData, error: errorMedicos } = await supabase\r\n      .from('medicos')\r\n      .select('*')\r\n      .eq('especialidad', 'Ginecolog√≠a') as { data: Medico[] | null; error: any }\r\n\r\n    if (errorMedicos) {\r\n      resultado.errores.push(`Error cargando m√©dicos: ${errorMedicos.message}`)\r\n      return resultado\r\n    }\r\n\r\n    const medicos = medicosData || []\r\n    \r\n    // Log para debugging: mostrar cantidad de m√©dicos cargados\r\n    console.log(`[Ginecolog√≠a] M√©dicos cargados: ${medicos.length}`)\r\n    console.log(`[Ginecolog√≠a] Residentes: ${medicos.filter(m => m.matricula_provincial === null).length}`)\r\n    console.log(`[Ginecolog√≠a] No residentes: ${medicos.filter(m => m.matricula_provincial !== null).length}`)\r\n    console.log(`[Ginecolog√≠a] Nombres de m√©dicos:`, medicos.map(m => `${m.nombre} (${m.matricula_provincial === null ? 'RESIDENTE' : 'NO RESIDENTE'})`).slice(0, 10))\r\n\r\n    // 2. Cargar valores de consultas ginecol√≥gicas\r\n    const { data: valoresData } = await supabase\r\n      .from('valores_consultas_obra_social')\r\n      .select('*')\r\n      .eq('tipo_consulta', 'CONSULTA GINECOLOGICA')\r\n      .eq('mes', mes)\r\n      .eq('anio', anio) as { data: ValorConsultaObraSocial[] | null }\r\n\r\n    const valoresConsultas = valoresData || []\r\n    const valoresPorObraSocial = new Map<string, number>()\r\n    valoresConsultas.forEach(v => {\r\n      valoresPorObraSocial.set(v.obra_social, v.valor)\r\n    })\r\n\r\n    // 3. Crear o obtener liquidaci√≥n\r\n    const numeroLiquidacion = calcularNumeroLiquidacion(mes, anio)\r\n    \r\n    // Verificar si ya existe\r\n    const { data: liquidacionExistente } = await supabase\r\n      .from('liquidaciones_guardia')\r\n      .select('id')\r\n      .eq('especialidad', 'Ginecolog√≠a')\r\n      .eq('mes', mes)\r\n      .eq('anio', anio)\r\n      .single()\r\n\r\n    let liquidacionId: string\r\n\r\n    if (liquidacionExistente && (liquidacionExistente as any).id) {\r\n      // Ya existe, usar la existente\r\n      liquidacionId = (liquidacionExistente as any).id\r\n      \r\n      // Eliminar detalles existentes\r\n      await supabase\r\n        .from('detalle_guardia')\r\n        .delete()\r\n        .eq('liquidacion_id', liquidacionId)\r\n    } else {\r\n      // Crear nueva liquidaci√≥n\r\n      const nuevaLiquidacion: LiquidacionGuardiaInsert = {\r\n        mes,\r\n        anio,\r\n        especialidad: 'Ginecolog√≠a',\r\n        estado: 'borrador',\r\n        total_consultas: 0,\r\n        total_bruto: 0,\r\n        total_retenciones: 0,\r\n        total_adicionales: 0,\r\n        total_neto: 0,\r\n        archivo_nombre: archivoNombre,\r\n        numero_liquidacion: numeroLiquidacion\r\n      }\r\n\r\n      const { data: liquidacionCreada, error: errorLiquidacion } = await supabase\r\n        .from('liquidaciones_guardia')\r\n        // @ts-ignore - La tabla no est√° en los tipos generados de Supabase a√∫n\r\n        .insert(nuevaLiquidacion)\r\n        .select('id')\r\n        .single()\r\n\r\n      if (errorLiquidacion) {\r\n        resultado.errores.push(`Error creando liquidaci√≥n: ${errorLiquidacion.message || 'Error desconocido'}. Detalles: ${JSON.stringify(errorLiquidacion)}`)\r\n        console.error('Error creando liquidaci√≥n:', errorLiquidacion)\r\n        return resultado\r\n      }\r\n\r\n      if (!liquidacionCreada || !(liquidacionCreada as any).id) {\r\n        resultado.errores.push(`Error: No se pudo crear la liquidaci√≥n. Respuesta: ${JSON.stringify(liquidacionCreada)}`)\r\n        console.error('Liquidaci√≥n no creada:', liquidacionCreada)\r\n        return resultado\r\n      }\r\n\r\n      liquidacionId = (liquidacionCreada as any).id\r\n    }\r\n\r\n    resultado.liquidacionId = liquidacionId\r\n\r\n    // 4. Extraer todos los nombres √∫nicos de \"Responsable\" del Excel\r\n    const nombresUnicos = new Set<string>()\r\n    const nombresOriginales = new Map<string, string>() // nombre normalizado -> nombre original\r\n    \r\n    console.log(`Extrayendo nombres √∫nicos de ${excelData.rows.length} filas del Excel`)\r\n    \r\n    for (const row of excelData.rows) {\r\n      const medicoNombre = buscarValor(row, [\r\n        'Responsable', 'responsable', 'RESPONSABLE',\r\n        'M√©dico', 'medico', 'MEDICO', 'Medico',\r\n        'Profesional', 'profesional', 'PROFESIONAL',\r\n        'M√©dico responsable', 'M√©dico Responsable', 'Medico Responsable',\r\n        'M√âDICO RESPONSABLE'\r\n      ])\r\n      \r\n      if (medicoNombre && typeof medicoNombre === 'string' && medicoNombre.trim() !== '') {\r\n        const nombreNormalizado = normalizarNombre(medicoNombre.trim())\r\n        if (nombreNormalizado !== '') {\r\n          nombresUnicos.add(nombreNormalizado)\r\n          // Guardar el nombre original (el primero que encontramos)\r\n          if (!nombresOriginales.has(nombreNormalizado)) {\r\n            nombresOriginales.set(nombreNormalizado, medicoNombre.trim())\r\n          }\r\n        }\r\n      }\r\n    }\r\n    \r\n    console.log(`[Mapeo] Nombres √∫nicos encontrados en Excel: ${nombresUnicos.size}`)\r\n    console.log(`[Mapeo] Nombres √∫nicos:`, Array.from(nombresUnicos).slice(0, 10))\r\n    \r\n    // 5. Buscar cada nombre √∫nico en la BD y crear mapa\r\n    const mapaNombresMedicos = new Map<string, Medico>() // nombre normalizado -> m√©dico\r\n    \r\n    for (const nombreNormalizado of nombresUnicos) {\r\n      const medico = buscarMedico(nombresOriginales.get(nombreNormalizado) || nombreNormalizado, medicos)\r\n      if (medico) {\r\n        mapaNombresMedicos.set(nombreNormalizado, medico)\r\n      }\r\n    }\r\n    \r\n    // Logging detallado del mapeo\r\n    const nombresEncontrados = Array.from(mapaNombresMedicos.keys())\r\n    const nombresNoEncontrados = Array.from(nombresUnicos).filter(n => !mapaNombresMedicos.has(n))\r\n    \r\n    console.log(`[Mapeo] M√©dicos encontrados: ${nombresEncontrados.length}/${nombresUnicos.size}`)\r\n    console.log(`[Mapeo] M√©dicos NO encontrados: ${nombresNoEncontrados.length}`)\r\n    \r\n    if (nombresEncontrados.length > 0) {\r\n      console.log(`[Mapeo] M√©dicos encontrados:`)\r\n      nombresEncontrados.forEach(nombreNorm => {\r\n        const medico = mapaNombresMedicos.get(nombreNorm)!\r\n        const nombreOriginal = nombresOriginales.get(nombreNorm) || nombreNorm\r\n        console.log(`  - \"${nombreOriginal}\" -> \"${medico.nombre}\" (${medico.matricula_provincial === null ? 'RESIDENTE' : 'NO RESIDENTE'})`)\r\n      })\r\n    }\r\n    \r\n    if (nombresNoEncontrados.length > 0) {\r\n      console.log(`[Mapeo] M√©dicos NO encontrados:`)\r\n      nombresNoEncontrados.forEach(nombreNorm => {\r\n        const nombreOriginal = nombresOriginales.get(nombreNorm) || nombreNorm\r\n        console.log(`  - \"${nombreOriginal}\" (normalizado: \"${nombreNorm}\")`)\r\n      })\r\n      resultado.advertencias.push(`M√©dicos no encontrados en BD (${nombresNoEncontrados.length}): ${nombresNoEncontrados.slice(0, 5).map(n => nombresOriginales.get(n) || n).join(', ')}${nombresNoEncontrados.length > 5 ? '...' : ''}`)\r\n    }\r\n    \r\n    // 6. Procesar cada fila del Excel usando el mapa\r\n    const detalles: DetalleGuardiaInsert[] = []\r\n    resultado.totalFilas = excelData.rows.length\r\n\r\n    if (excelData.rows.length === 0) {\r\n      resultado.errores.push('El Excel no contiene filas de datos')\r\n      return resultado\r\n    }\r\n\r\n    console.log(`Procesando ${excelData.rows.length} filas del Excel`)\r\n    console.log('Headers disponibles:', excelData.headers)\r\n\r\n    // Contadores para debugging\r\n    let filasSinFecha = 0\r\n    let filasFechaInvalida = 0\r\n    let filasProcesadas = 0\r\n\r\n    for (let i = 0; i < excelData.rows.length; i++) {\r\n      const row = excelData.rows[i]\r\n      \r\n      try {\r\n        // Extraer datos de la fila - AUMENTAR VARIACIONES DE B√öSQUEDA\r\n        const fechaStr = buscarValor(row, [\r\n          'Fecha', 'fecha', 'FECHA', \r\n          'Fecha visita', 'Fecha Visita', 'Fecha de visita',\r\n          'Fecha de Visita', 'Fecha De Visita',\r\n          'Fecha de atenci√≥n', 'Fecha Atenci√≥n', 'Fecha de Atenci√≥n',\r\n          'Fecha de la consulta', 'Fecha Consulta', 'Fecha de Consulta',\r\n          'FECHA VISITA', 'FECHA DE VISITA',\r\n          'Fecha Visita', 'Fecha visita'\r\n        ])\r\n        const hora = buscarValor(row, [\r\n          'Hora', 'hora', 'HORA', \r\n          'Horario', 'horario', 'HORARIO',\r\n          'Hora inicio', 'Hora Inicio', 'Hora de inicio',\r\n          'Hora de Inicio', 'HORA INICIO'\r\n        ])\r\n        const paciente = buscarValor(row, [\r\n          'Paciente', 'paciente', 'PACIENTE', \r\n          'Nombre paciente', 'Nombre Paciente', 'Nombre del paciente',\r\n          'NOMBRE PACIENTE'\r\n        ])\r\n        const obraSocial = buscarValor(row, [\r\n          'Obra Social', 'obra social', 'Obra social', \r\n          'ObraSocial', 'Cliente', 'Obra', \r\n          'Obra Social / Cliente', 'Obra Social/Cliente',\r\n          'OBRA SOCIAL', 'CLIENTE'\r\n        ])\r\n        const medicoNombre = buscarValor(row, [\r\n          'Responsable', 'responsable', 'RESPONSABLE',\r\n          'M√©dico', 'medico', 'MEDICO', 'Medico',\r\n          'Profesional', 'profesional', 'PROFESIONAL',\r\n          'M√©dico responsable', 'M√©dico Responsable', 'Medico Responsable',\r\n          'M√âDICO RESPONSABLE'\r\n        ])\r\n        \r\n        // MEJORAR: Intentar m√∫ltiples formatos de fecha\r\n        let fecha: string | null = null\r\n        \r\n        if (fechaStr) {\r\n          // Intentar formato DD/MM/YYYY\r\n          fecha = convertirFechaISO(fechaStr)\r\n          \r\n          // Si falla, intentar otros formatos\r\n          if (!fecha) {\r\n            // Intentar formato YYYY-MM-DD\r\n            const matchISO = String(fechaStr).match(/(\\d{4})-(\\d{1,2})-(\\d{1,2})/)\r\n            if (matchISO) {\r\n              fecha = fechaStr // Ya est√° en formato ISO\r\n            } else {\r\n              // Intentar parsear como Date object\r\n              try {\r\n                const dateObj = new Date(fechaStr)\r\n                if (!isNaN(dateObj.getTime())) {\r\n                  const year = dateObj.getFullYear()\r\n                  const month = String(dateObj.getMonth() + 1).padStart(2, '0')\r\n                  const day = String(dateObj.getDate()).padStart(2, '0')\r\n                  fecha = `${year}-${month}-${day}`\r\n                }\r\n              } catch {\r\n                // Ignorar error\r\n              }\r\n            }\r\n          }\r\n        }\r\n        \r\n        // Validar datos m√≠nimos - PERMITIR FILAS SIN FECHA PERO REGISTRAR ADVERTENCIA\r\n        if (!fecha) {\r\n          filasSinFecha++\r\n          resultado.advertencias.push(`Fila ${i + 1}: Sin fecha v√°lida (${fechaStr || 'vac√≠a'}), se omite`)\r\n          continue\r\n        }\r\n\r\n        // Validar que la fecha sea razonable (entre 2020 y 2100)\r\n        const fechaAnio = parseInt(fecha.split('-')[0])\r\n        if (fechaAnio < 2020 || fechaAnio > 2100) {\r\n          filasFechaInvalida++\r\n          resultado.advertencias.push(`Fila ${i + 1}: Fecha fuera de rango (${fecha}), se omite`)\r\n          continue\r\n        }\r\n\r\n        // Buscar m√©dico en el mapa (ya pre-calculado)\r\n        let medico: Medico | null = null\r\n        if (medicoNombre && typeof medicoNombre === 'string' && medicoNombre.trim() !== '') {\r\n          const nombreNormalizado = normalizarNombre(medicoNombre.trim())\r\n          medico = mapaNombresMedicos.get(nombreNormalizado) || null\r\n        }\r\n        \r\n        // Determinar si es residente: matricula_provincial IS NULL = residente\r\n        const esResidente = medico ? (medico.matricula_provincial === null) : false\r\n\r\n        // Si no se encuentra el m√©dico, registrar advertencia pero continuar (solo una vez por nombre √∫nico)\r\n        if (!medico && medicoNombre) {\r\n          // Solo registrar advertencia si es la primera vez que vemos este nombre\r\n          const nombreNormalizado = normalizarNombre(medicoNombre.trim())\r\n          if (!mapaNombresMedicos.has(nombreNormalizado)) {\r\n            // Ya se registr√≥ en el mapeo inicial, no duplicar\r\n          }\r\n        }\r\n\r\n        // Obtener valor de consulta\r\n        const obraSocialFinal = obraSocial || 'PARTICULARES' // Asignar 'PARTICULARES' autom√°ticamente si no hay obra social\r\n        const valorUnitario = valoresPorObraSocial.get(obraSocialFinal) || 0\r\n\r\n        // Si no hay valor para la obra social, registrar advertencia\r\n        if (valorUnitario === 0 && obraSocialFinal !== 'PARTICULARES') {\r\n          resultado.advertencias.push(`Fila ${i + 1}: No hay valor configurado para obra social: ${obraSocialFinal}`)\r\n        }\r\n\r\n        // Aplicar regla de residentes\r\n        const horaFormato = convertirHora(hora)\r\n        const esHorarioFormativo = esResidenteHorarioFormativo(fecha, horaFormato, esResidente)\r\n        \r\n        let montoFacturado = valorUnitario\r\n        let importeCalculado = valorUnitario\r\n\r\n        if (esHorarioFormativo) {\r\n          // Residente en horario formativo: no se paga\r\n          montoFacturado = 0\r\n          importeCalculado = 0\r\n        }\r\n\r\n        // Crear detalle\r\n        const detalle: DetalleGuardiaInsert = {\r\n          liquidacion_id: liquidacionId,\r\n          medico_id: medico?.id || null,\r\n          fecha,\r\n          hora: horaFormato,\r\n          paciente: paciente || null,\r\n          obra_social: obraSocialFinal, // Puede ser null si no hay obra social\r\n          medico_nombre: medicoNombre || medico?.nombre || 'Desconocido',\r\n          medico_matricula: medico?.matricula_provincial || null,\r\n          medico_es_residente: esResidente,\r\n          monto_facturado: montoFacturado,\r\n          porcentaje_retencion: null, // Ginecolog√≠a no tiene retenci√≥n del 30%\r\n          monto_retencion: null,\r\n          monto_adicional: 0,\r\n          importe_calculado: importeCalculado,\r\n          aplica_adicional: false,\r\n          es_horario_formativo: esHorarioFormativo,\r\n          estado_revision: 'pendiente',\r\n          fila_excel: i + 1\r\n        }\r\n\r\n        detalles.push(detalle)\r\n        filasProcesadas++\r\n        resultado.procesadas++\r\n\r\n      } catch (error: any) {\r\n        const errorMsg = error.message || 'Error desconocido'\r\n        resultado.errores.push(`Fila ${i + 1}: ${errorMsg}`)\r\n        console.error(`Error procesando fila ${i + 1}:`, error)\r\n        console.error('Datos de la fila:', row)\r\n      }\r\n    }\r\n\r\n    // Agregar resumen de advertencias al final\r\n    console.log(`Resumen: ${filasProcesadas} procesadas, ${filasSinFecha} sin fecha, ${filasFechaInvalida} fecha inv√°lida`)\r\n    if (filasSinFecha > 0 || filasFechaInvalida > 0) {\r\n      resultado.advertencias.push(`Total omitidas: ${filasSinFecha + filasFechaInvalida} (${filasSinFecha} sin fecha, ${filasFechaInvalida} fecha inv√°lida)`)\r\n    }\r\n\r\n    // 5. Guardar detalles en la base de datos\r\n    if (detalles.length === 0) {\r\n      resultado.errores.push('No se proces√≥ ninguna fila v√°lida. Verifique que el Excel tenga fechas v√°lidas.')\r\n      return resultado\r\n    }\r\n\r\n    console.log(`Guardando ${detalles.length} detalles en la base de datos`)\r\n    \r\n    // Insertar en lotes de 100 para evitar problemas de tama√±o\r\n    const batchSize = 100\r\n    for (let i = 0; i < detalles.length; i += batchSize) {\r\n      const batch = detalles.slice(i, i + batchSize)\r\n      const { error: errorDetalles } = await supabase\r\n        .from('detalle_guardia')\r\n        // @ts-ignore - La tabla no est√° en los tipos generados de Supabase a√∫n\r\n        .insert(batch)\r\n\r\n      if (errorDetalles) {\r\n        resultado.errores.push(`Error guardando detalles (lote ${Math.floor(i / batchSize) + 1}): ${errorDetalles.message}. Detalles: ${JSON.stringify(errorDetalles)}`)\r\n        console.error('Error guardando detalles:', errorDetalles)\r\n        console.error('Primer detalle del lote:', batch[0])\r\n        return resultado\r\n      }\r\n    }\r\n\r\n    // 6. Actualizar totales de la liquidaci√≥n\r\n    const totalConsultas = detalles.length\r\n    const totalBruto = detalles.reduce((sum, d) => sum + (d.monto_facturado || 0), 0)\r\n    const totalNeto = detalles.reduce((sum, d) => sum + (d.importe_calculado || 0), 0)\r\n\r\n    const { error: errorUpdate } = await supabase\r\n      .from('liquidaciones_guardia')\r\n      // @ts-ignore - La tabla no est√° en los tipos generados de Supabase a√∫n\r\n      .update({\r\n        total_consultas: totalConsultas,\r\n        total_bruto: totalBruto,\r\n        total_neto: totalNeto,\r\n        estado: 'finalizada' // Estado inicial: finalizada (como estaba antes)\r\n      })\r\n      .eq('id', liquidacionId)\r\n\r\n    if (errorUpdate) {\r\n      resultado.errores.push(`Error actualizando totales: ${errorUpdate.message}`)\r\n    }\r\n\r\n  } catch (error: any) {\r\n    resultado.errores.push(`Error general: ${error.message || 'Error desconocido'}`)\r\n  }\r\n\r\n  return resultado\r\n}\r\n\r\n"],"names":[],"mappings":"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"}